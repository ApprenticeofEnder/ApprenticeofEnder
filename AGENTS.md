# AGENTS.md -- Agentic Coding Instructions

This is a **Nix-based personal system configuration** repository (dotfiles + multi-machine config).
All code is in the **Nix expression language**. There is no traditional build/compile step --
the project is declarative configuration consumed by home-manager, nix-darwin, and NixOS.

## Build / Lint / Test Commands

```bash
# Format all Nix files (Alejandra formatter)
just lint          # or: nix fmt .

# Run flake checks (includes pre-commit hooks)
just check         # or: nix flake check

# Activate the home-manager configuration
just run           # or: nix run
just run-generic   # non-NixOS: nix run '.#non-nixos'

# Update all flake inputs
just update        # or: nix flake update

# Enter the dev shell
just dev           # or: nix develop

# Run tests (verifies git and pulumi-esc versions)
devenv test
```

There is no single-test command. `devenv test` is the only test suite and it runs in full.
`nix flake check` is the closest thing to CI -- it validates the flake and runs pre-commit hooks.

## Pre-commit Hooks

These run automatically on commit. Do NOT edit `.pre-commit-config.yaml` (auto-generated).

| Hook | What it does |
|------|--------------|
| `alejandra` | Formats `.nix` files |
| `deadnix` | Detects unused Nix bindings |
| `vale` | Prose linting (proselint + write-good) on markdown |
| `shellcheck` | Lints shell scripts (excludes `.zsh`) |
| `convco` | Enforces conventional commit messages |

## Commit Message Convention

Conventional commits enforced by `convco`:

```
feat: add new program configuration
fix: correct package name in packages.nix
chore: update flake inputs
refactor: reorganize module structure
docs: update README template
```

## Code Style

### Formatter

**Alejandra** is the sole Nix formatter. Run `just lint` or `nix fmt .` before committing.

### Naming Conventions

- **Files:** lowercase with hyphens (`nix-index.nix`, `ai-server.nix`)
- **Directories as modules:** use `default.nix` as entry point
- **Options:** camelCase (standard Nix/home-manager convention)
- **Custom options:** under `me.*` (`me.username`, `me.fullname`, `me.email`)

### Nix Idioms

- Function args: `{ pkgs, lib, config, ... }:` destructuring pattern
- `let ... in` blocks for local bindings
- `with pkgs;` in package lists to avoid repetitive `pkgs.` prefixes
- `pkgs-stable.*` for stable nixpkgs packages (primary `pkgs` = nixos-unstable)
- `lib.optionals stdenv.isLinux` / `stdenv.isDarwin` for platform guards
- Inline `#` comments to describe individual packages

### Module Patterns

**Auto-import pattern** (used in most module directories):
```nix
imports = with builtins;
  map (fn: ./${fn}) (filter (fn: fn != "default.nix") (attrNames (readDir ./.)));
```

Variants:
1. **Simple auto-import** -- `modules/home/`, `linux-only/`, `darwin-only/`
2. **Filtered** -- `modules/home/programs/` excludes `linux-only`/`darwin-only` dirs
3. **Backup-filtered** -- `modules/home/services/` excludes `.bak.nix` files
4. **No auto-import** -- `modules/home/toolkits/` (imported explicitly per-configuration)

### Adding New Modules

- **Simple config:** single file `program.nix` in the appropriate directory
- **Complex config:** directory `program/default.nix` + supporting files (themes, scripts)
- **New toolkit:** add to `modules/home/toolkits/`, then explicitly import in `configurations/home/*.nix`
- **New service:** drop in `modules/home/services/` (auto-imported unless `.bak.nix` suffix)

### Platform-Specific Code

- Linux-only programs: `modules/home/programs/linux-only/`
- macOS-only programs: `modules/home/programs/darwin-only/`
- Inline guards: `lib.optionals stdenv.isLinux [ ... ]`

## Do NOT Modify (Auto-generated)

- `.pre-commit-config.yaml` -- generated by `git-hooks.nix`
- `.devenv.flake.nix` -- generated by devenv
- `README.md` -- generated from `templates/README.j2.md` (edit templates instead)

## Secrets

Managed via **Pulumi ESC** (loaded in `.envrc`). Never commit secrets to the repo.
1Password CLI integration aliases `aws` and `gh` through `op plugin run`.

## nixpkgs Channel Strategy

This is **reversed from typical convention**:
- `pkgs` = **nixos-unstable** (primary, used for most packages)
- `pkgs-stable` = **nixos-25.11** (stable fallback, via `_module.args.pkgs-stable`)

## Key Architecture

- **nixos-unified** autowires `configurations/` to flake outputs
- **Activation fallback:** tries `user@hostname`, falls back to `user@`
- **Dotfile hybrid:** most configs via home-manager; nvim and starship via GNU Stow from `dotfiles/`
- **README-as-code:** Jinja2 templates in `templates/` auto-regenerated on shell entry

## General Coding Guidelines

### Simplicity First
- No features beyond what was asked
- No abstractions for single-use code
- No speculative "flexibility" or "configurability"
- If 200 lines could be 50, rewrite it

### Surgical Changes
- Don't "improve" adjacent code, comments, or formatting
- Don't refactor things that aren't broken
- Match existing style exactly
- Remove only orphans YOUR changes created
- Every changed line should trace directly to the request

### Never Nesting
- Do not nest more than 3 layers deep (counting from class or function level)
- Use guard clauses to avoid unnecessary nesting
- Extract to a function if nesting exceeds 2 layers

### Modularity
- If writing the same thing with minor tweaks more than twice, refactor
- Use loops for repetitive patterns, functions for repeated logic

### Security and Robustness
- Consider security implications of every change
- Never allow code to fail silently
- Test and guard against the worst case scenario

## Task Completion Checklist

1. `just lint` -- format all Nix files
2. `just check` -- run flake checks and pre-commit hooks
3. `just run` -- test activation (if home-manager modules changed)
4. Commit with conventional commit message
